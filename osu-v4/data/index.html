<!DOCTYPE HTML>
<HTML>
    <head>
        <meta charset="utf-8">
        <meta name="google" value="notranslate">
        <meta http-equiv="X-Content-Security-Policy" content="default-src 'self'; script-src 'self'">
        <title>Calico</title>
        <link rel="icon" type="image/png" href="./blocklyduino/media/logo_only.png" />
        <link rel="stylesheet" href="./css/font_awesome_all.min.css" />
        <link rel="stylesheet" href="./css/keyboard_nav.css" />
        <link rel="stylesheet" href="./css/lateral-panel.css" />
        <link rel="stylesheet" href="./css/UI.css" />
        <link rel="stylesheet" href="./blocklyduino/css/blocklyduino.css" />
        <link rel="stylesheet" href="./blocklyduino/css/override_css.css" />
    </head>
    <body>
        <div class="table_wrapper">
            <table id="globalTable">
                <tr id="optionsTop">
                    <td  id="optionsTopTitle">
                        <img src="./blocklyduino/media/logo_only2.png" style="width: 25px; vertical-align: middle;" />
                        <span class="TitleText" id="appName"></span>
                    </td>
                    <!-- <span class="sketch_name_wrapper"> -->
                        <!-- <i class="mdi-image-edit sketch_name_icon active"></i> -->
                        <!-- <input id="sketch_name" class="sketch_name" type="text" size="10"> -->
                    <!-- </span>         -->
                    <td  id="optionsTopInteractiveHelp" class="tabMiddle">
                        <span id="content_hoverButton"></span>
                    </td>
                </tr>
                <tr  id="functionsIcons">
                    <td colspan="2">
                        <button id="menuButton" class="iconButtons" onclick="document.getElementById('menuPopup').style.display = 'block';document.getElementById('menuButton').classList.toggle('active');">
                            <span id="menuButtonButton_span">
                                <i class="fas fa-ellipsis-v"></i>
                            </span>
                        </button>
                        <div id="menuPopup" class="popup_bckgrd" style="display:none" onclick="document.getElementById('menuPopup').style.display = 'none';document.getElementById('menuButton').classList.toggle('active');">
                            <div id="buttonsMenuPopup" class="menu_div">
                                <div id="buttonsMenuPopupInside">
                                    
                                    <button id="newButton" class="iconButtons" onclick="Code.newProject()">
                                        <span id="newButton_span"></span>
                                    </button>
                                    <span id="newButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <button id="loadXMLfakeButton" class="iconButtons" onclick="Code.loadXmlBlocklyFile()">
                                        <span id="loadXMLfakeButton_span"></span>
                                    </button>
                                    <span id="loadXMLfakeButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <button id="saveXMLButton" class="iconButtons" onclick="Code.saveXmlBlocklyFile()">
                                        <span id="saveXMLButton_span"></span>
                                    </button>
                                    <span id="saveXMLButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <button id="saveCodeButton" class="iconButtons" onclick="Code.saveCodeFile()">
                                        <span id="saveCodeButton_span"></span>
                                    </button>
                                    <span id="saveCodeButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="parametersButton" class="iconButtons" onclick="document.getElementById('lateral-panel-setup-input').click();">
                                        <span id="parametersButton_span">
                                            <i class="fas fa-cog"></i>
                                        </span>
                                    </button>
                                    <span id="parametersButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="resetButton" class="iconButtons" onclick="Code.ResetWorkspace()">
                                        <span id="resetButton_span">
                                            <i class="fas fa-power-off"></i>
                                        </span>
                                    </button>
                                    <span id="resetButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="helpButton" class="iconButtons" onclick="toggleDisplayHelpModal()">
                                        <span id="helpButton_span">
                                            <i class="fas fa-question"></i>
                                        </span>
                                    </button>
                                    <span id="helpButton_span_menu" class="menu_text"></span>
                                </div>
                            </div>
                        </div>
                        <button id="fullScreenButton" class="iconButtons" onclick="fullScreen()">
                            <span id="fullScreenButton_span">
                                <i class="fas fa-expand-arrows-alt"></i>
                            </span>
                        </button>
                        <button id="undoButton" class="iconButtons" onclick="Code.Undo()">
                            <span id="undoButton_span">
                                <i class="fas fa-undo-alt"></i>
                            </span>
                        </button>
                        <button id="redoButton" class="iconButtons" onclick="Code.Redo()">                           
                            <span id="redoButton_span">
                                <i class="fas fa-redo-alt"></i>
                            </span>
                        </button>
                        <button id="toolsButton" class="iconButtons" onclick="document.getElementById('toolsPopup').style.display = 'block';document.getElementById('toolsButton').classList.toggle('active');">
                            <span id="toolsButton_span">
                                <i class="fas fa-toolbox"></i>
                            </span>
                        </button>
                        <div id="toolsPopup" class="popup_bckgrd" style="display:none" onclick="document.getElementById('toolsPopup').style.display = 'none';document.getElementById('toolsButton').classList.toggle('active');">
                            <div id="buttonsToolsPopup" class="menu_div">
                                <div id="buttonsToolsPopupInside">
                                    <button id="wiringButton" class="iconButtons">
                                        <span id="wiringButton_span">
                                            <i class="fas fa-code-branch"></i>
                                        </span>
                                    </button>
                                    <span id="wiringButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="factoryButton" class="iconButtons">
                                        <span id="factoryButton_span">
                                            <i class="fas fa-industry"></i>
                                        </span>
                                    </button>
                                    <span id="factoryButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="htmlButton" class="iconButtons">
                                        <span id="htmlButton_span">
                                            <i class="fab fa-firefox-browser"></i>
                                        </span>
                                    </button>
                                    <span id="htmlButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="colorConversionButton" class="iconButtons" onclick="">
                                        <span id="colorConversionButton_span">
                                            <i class="fas fa-swatchbook"></i>
                                        </span>
                                    </button>
                                    <span id="colorConversionButton_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="dataConversionButton" class="iconButtons" onclick="">
                                        <span id="dataConversionButton_span">
                                            <i class="fas fa-exchange-alt"></i>
                                        </span>
                                    </button>
                                    <span id="dataConversionButton_span_menu" class="menu_text"></span>
                                </div>
                            </div>
                        </div>
                        <button id="iotConnectButton" class="iconButtons" onclick="document.getElementById('iotPopup').style.display = 'block';document.getElementById('iotConnectButton').classList.toggle('active');">
                            <span id="iotConnectButton_span">
                                <i class="fas fa-link"></i>
                            </span>
                        </button>
                        <div id="iotPopup" class="popup_bckgrd" style="display:none" onclick="document.getElementById('iotPopup').style.display = 'none';document.getElementById('iotConnectButton').classList.toggle('active');">
                            <div id="buttonsIotPopup" class="menu_div">
                                <div id="buttonsIotPopupInside">
                                    <button id="launchWebServer" class="iconButtons CLI">
                                        <span id="launchWebServer_span">
                                            <i class="fas fa-network-wired"></i>
                                        </span>
                                    </button>
                                    <span id="launchWebServer_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="papyrusConnect" class="iconButtons CLI" onclick="papyrusConnect()">
                                        <span id="papyrusConnect_span">
                                            <img src="./blocklyduino/media/Eclipse_papyrus_logo.png" style="width: 30px; height: 30px; vertical-align: middle;"/>
                                        </span>
                                    </button>
                                    <span id="papyrusConnect_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="registerToOrchestrator" class="iconButtons CLI" onclick="ArrowheadRegister()">
                                        <span id="registerToOrchestrator_span">
                                            <img src="./blocklyduino/media/arrowheadtools_invert.png" style="width: 30px; height: 30px; vertical-align: middle;"/>
                                        </span>
                                    </button>
                                    <span id="registerToOrchestrator_span_menu" class="menu_text"></span>
                                    <br>
                                    <hr>
                                    <button id="blynkConnect" class="iconButtons CLI" onclick="">
                                        <span id="blynkConnect_span">
                                            <img src="./blocklyduino/media/blynk.png" style="width: 30px; height: 30px; vertical-align: middle;"/>
                                        </span>
                                    </button>
                                    <span id="blynkConnect_span_menu" class="menu_text"></span>
                                </div>
                            </div>
                        </div>
                        <button id="boardButton" class="iconButtons" onclick="Code.boardsListModalShow()">
                            <span id="boardButton_span">
                                <i class="fas fa-microchip"></i>
                            </span>
                        </button>
                        <button id="verifyButton" class="iconButtons" onclick="Code.verifyCodeFile()">
                            <span id="verifyButton_span">
                                <i class="fas fa-check"></i>
                            </span>
                        </button>
                        <button id="serialButton" class="iconButtons" onclick="Code.portsListModalShow()">
                            <span id="serialButton_span">
                                <i class="fab fa-usb"></i>
                            </span>
                        </button>
                        <button id="uploadButton" class="iconButtons" onclick="Code.uploadCodeFile()">
                            <span id="uploadButton_span">
                                <i class="fas fa-sign-out-alt"></i>
                            </span>
                        </button>
                        <button id="serialConnectButton" class="iconButtons">
                            <span id="serialConnectButton_span">
                                <i class="fas fa-search"></i>
                            </span>
                        </button>
                    </td>
                </tr>
                <tr id="globalWorkspace">                  
                    <td colspan="2">
                        <div class="content_wrapper">
                            <div id="wrapper_up" class="wrapper_up">
                                <div id="content_area">
                                    <div id="content_blocks"></div>
                                </div>
                                <div id="separator">
                                    <label id="editorReadOnlyToggle" class="switch">
                                        <input type="checkbox" onclick="toggleEditorReadOnly(this)">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <button id="copyCodeButton" class="iconButtons" onclick="Code.copyToClipboard()">
                                    <span id="copyCodeButton_span">
                                        <i class="far fa-copy"></i>
                                    </span>
                                </button>
                                <div id="content_code"></div>
                            </div>
                            <div id="barre_h">
                                <div id="checkDetails">
                                    <input type="checkbox" name="detailedCompilation" id="detailedCompilation"/>
                                    <span id="detailedCompilation_span"> </span>
                                </div>
                                <div id="infoBoardPort">                                
                                    <span id="boardSelected_span"> </span>
                                    <span id="portSelected_span"> </span>
                                    <button id="consoleOutsideButton" class="iconButtons" onclick="">
                                        <span name="consoleOutside" id="consoleOutside_span">
                                            <i class="fas fa-external-link-alt"></i>
                                        </span>
                                    </button>
                                </div>
                            </div>
                            <div id="content_serial"></div>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        <div id="helpModal" class="helpModal">
            <div id="helpModal_header">
                <span id="helpModalSpan_title"></span>
            </div>
            <div id="helpModal_text">
                <span id="helpModalSpan_text"></span>
            </div>
        </div>
        <div id="keyboard_nav">
            <div id="keyboard_nav_header">
                <span id="keyMappingModalSpan"></span>
            </div>
            <form id="keyboard_mappings"></form>
        </div>
        <div id="lateral-panel-setup">
            <input id="lateral-panel-setup-input" type="checkbox">
            <label id="lateral-panel-setup-label" for="lateral-panel-setup-input" class="label_panel">
                <span id="setup_side_span">
                    <i class="fas fa-cog"></i>
                </span>
            </label>
            <div id="lateral-panel-setup-bloc">
                <button class="accordion">
                    <span id="config_UI_title_span" aria-expanded="false" aria-controls="accordion_setup_content"></span>
                </button></button>
                <div id="setup_content" class="side_content config_content panel">
                    <form id="options">
                        <select id="boardMenu" style='display:none'>
                            <option value="none" selected="selected">...</option>
                            <option value="arduino_leonardo">Arduino Leonardo</option>
                            <option value="arduino_mega">Arduino Mega</option>
                            <option value="arduino_micro">Arduino Micro</option>
                            <option value="arduino_mini">Arduino Mini</option>
                            <option value="arduino_nano">Arduino Nano</option>
                            <option value="arduino_pro8">Arduino Pro Mini 3.3V</option>
                            <option value="arduino_pro16">Arduino Pro Mini 5V</option>
                            <option value="arduino_uno">Arduino Uno</option>
                            <option value="arduino_yun">Arduino Yùn</option>
                            <option value="lilypad">LilyPad</option>
                        </select>
                        <br>
                        <span id="languageSpan" class="UIText">...</span>
                        <select id="languageMenu"></select>
                        <br>
                        <br>
                        <span id="interfaceColorSpan" class="UIText">...</span>
                        <select id="interfaceColorMenu">
                            <option value="arduino" selected="selected">blocklyduino2</option>
                        </select>
                        <br>
                        <span id="codeEditorColorSpan" class="UIText">...</span>
                        <select id="codeEditorColorMenu">
                            <option value="arduino" selected="selected">blocklyduino2</option>
                        </select>
                        <br>
                        <br>
                        <span id="themeSpan" class="UIText">...</span>
                        <select name="theme" onchange="changeTheme(this.value)">
                            <option value="classic" id="themeClassicSpan">classic</option>
                            <option value="modern" id="themeModernSpan">modern</option>
                            <option value="deuteranopia" id="themeDeuteranopiaSpan">deuteranopia</option>
                            <option value="tritanopia" id="themeTritanopiaSpan">tritanopia</option>
                            <option value="zelos" id="themeZelosSpan">zelos</option>
                            <option value="high_contrast" id="themeHighContrastSpan">high_contrast</option>
                            <option value="dark" id="themeDarkSpan">dark</option>
                            <option value="blackWhite" id="themeBwSpan">blackWhite</option>
                        </select>
                        <br>
                        <span id="renderSpan" class="UIText">...</span>
                        <select name="renderer" onchange="document.forms.options.submit('options')">
                            <option value="geras">Geras</option>
                            <option value="thrasos">Thrasos</option>
                            <option value="zelos">Zelos</option>
                            <option value="minimalist">Minimalist</option>
                        </select>
                    </form>
                    <br>
                    <span id="displaySpan" class="UIText">...</span>
                    <select name="displayChoice" onchange="">
                        <option value="button" id="displayChoiceButtons">buttons</option>
                        <option value="buttonText" id="displayChoiceBandT">buttons + text</option>
                        <option value="text" id="displayChoiceText">text</option>
                    </select>
                    <br>
                    <br>
                    <span id="fontSpan" class="UIText">...</span>
                    <select name="fontChoice" onchange="document.forms.options.submit('options')">
                        <option value="arial">Arial</option>
                        <option value="comics">Comic Sans MS</option>
                        <option value="luciole">Luciole</option>
                        <option value="opendyslexic">Open Dyslexic</option>
                        <option value="trebuchet">Trebuchet MS</option>
                        <option value="verdana">Verdana</option>
                    </select>
                    <br>
                    <span id="fontSizeSpan" class="UIText"></span>
                    <select id="rendering-constant-selector">
                        <option value="fontSizeBlocks" id="optionFontSizeBlocks" selected="selected">Blocks & Editor Font Size</option>
                        <option value="fontSizePage" id="optionFontSizePage">Page Font Size</option>
                        <option value="fontSpacingPage" id="optionFontSpacingPage">Page Font Spacing</option>
                    </select>
                    <br>
                    <input type="range" min="3" max="50" value="4" oninput="Code.changeRenderingConstant(this.value)" onchange="Code.changeRenderingConstant(this.value)" />
                    <br>
                    <br>
                    <input id="accessibilityModeCheck" type="checkbox" onclick="toggleAccessibilityMode(this.checked)">
                    <span id="accessibilitySpan" class="UIText"></span>
                    <br>
                    <input id="displayKeyMappings" type="checkbox" onclick="toggleDisplayKeyMappings(this.checked)">
                    <span id="keyMappingSpan" class="UIText"></span>
                    <br>
                    <select id="cursorChanger" name="cursor" onchange="changeCursor(this.value)">
                        <option value="default" id="defaultCursorSpan">default</option> 
                        <option value="basic" id="basicCursorSpan">basic</option>
                        <option value="line" id="lineCursorSpan">line</option>
                    </select>
                    <br>
                </div>
                <button class="accordion_cli">
                    <span id="CLI_title_span" aria-expanded="false" aria-controls="accordion_CLI_content"></span>
                </button>
                <div id="CLI_content" class="side_content config_content CLI panel">
                    <div id="configCLI">
                        <div id="CLI_title">
                            <button id="coreUpdateButton" class="iconButtons CLI" onclick="">
                                <span id="coreUpdateButton_span">
                                    <i class="fas fa-sync"></i>
                                </span>
                            </button>
                            <button id="cleanCLIcacheButton" class="iconButtons CLI" onclick="">
                                <span id="cleanCLIcache_span">
                                    <i class="fas fa-eraser"></i>
                                </span>
                            </button>
                            <button id="listBoardsButton" class="iconButtons CLI" onclick="">
                                <span id="listBoardsButton_span">
                                    <i class="fas fa-list"></i>
                                </span>
                            </button>
                            <a href="https://arduino.github.io/arduino-cli/" id="CLI_githubLinkButton" target="_blank">
                                <img src="./blocklyduino/media/featured-CLI.png" style="height: 40px" />
                            </a>
                        </div>
                        <br>
                        <span id="installBoard_title_span" class="UIText CLI">install board</span>
                        <br>
                        <input type="text" class="controlPanelInput" id="installBoardsInput" name="installBoardsInput">
                        <button id="installBoardsButton" class="iconButtons CLI" onclick="">
                            <span id="installBoardsButton_span">
                                <i class="fas fa-cloud-download-alt"></i>
                            </span>
                        </button>
                        <br>
                        <br>
                        <span id="searchlLib_title_span" class="UIText">search library</span>
                        <br>
                        <input type="text" class="controlPanelInput" id="searchlLibInput" name="searchlLibInput">
                        <button id="searchlLibButton" class="iconButtons CLI" onclick="">
                            <span id="searchlLibButton_span">
                                <i class="fab fa-searchengin"></i>
                            </span>
                        </button>
                        <br>
                        <br>
                        <span id="installLib_title_span" class="UIText">install library</span>
                        <br>
                        <input type="text" class="controlPanelInput" id="installLibInput" name="installLibInput">
                        <button id="installLibButton" class="iconButtons CLI" onclick="">
                            <span id="installLibButton_span">
                                <i class="fas fa-cloud-download-alt"></i>
                            </span>
                        </button>
                        <br>
                    </div>
                </div>
                <button class="accordion">
                    <!-- <select name="toolbox" onchange="document.forms.options.submit('options')"> -->
                        <!-- <option value="categories">Categories (untyped variables)</option> -->
                        <!-- <option value="categories-typed-variables">Categories (typed variables)</option> -->
                        <!-- <option value="simple">Simple</option> -->
                        <!-- <option value="test-blocks">Test Blocks</option> -->
                    <!-- </select> -->
                    <span id="categories_title_span" aria-expanded="false" aria-controls="accordion_categories_content"></span>
                </button>
                <div id="categories_content" class="side_content config_content panel UIText">
                </div>
                <button class="accordion_iot">
                    <span id="iot_title_span" aria-expanded="false" aria-controls="accordion_categories_content"></span>
                </button>
                <div id="arrowhead_controls" class="side_content config_content panel UIText">
                    <input type="text" class="controlPanelInput" id="launchWebServerInput" name="launchWebServerInput">
                    <button id="launchWebServer" class="iconButtons CLI">
                        <span id="launchWebServer_span">
                            <i class="fas fa-network-wired"></i>
                        </span>
                    </button>
                    <br>
                    <br>
                    <input type="text" class="controlPanelInput" id="papyrusConnectInput" name="papyrusConnectInput">
                    <button id="papyrusConnect" class="iconButtons CLI" onclick="papyrusConnect()">
                        <span id="papyrusConnect_span">
                            <img src="./blocklyduino/media/Eclipse_papyrus_logo.png" style="width: 30px; height: 30px; vertical-align: middle;"/>
                        </span>
                    </button>
                    <br>
                    <br>
                    <input type="text" class="controlPanelInput" id="arrowheadConnectInput" name="arrowheadConnectInput">
                    <button id="registerToOrchestrator" class="iconButtons CLI" onclick="ArrowheadRegister()">
                        <span id="registerToOrchestrator_span">
                            <img src="./blocklyduino/media/arrowheadtools_invert.png" style="width: 30px; height: 30px; vertical-align: middle;"/>
                        </span>
                    </button>
                    <br>
                    <br>
                    <input type="text" class="controlPanelInput" id="blynkConnectInput" name="blynkConnectInput">
                    <button id="blynkConnect" class="iconButtons CLI" onclick="">
                        <span id="blynkConnect_span">
                            <img src="./blocklyduino/media/blynk.png" style="width: 30px; height: 30px; vertical-align: middle;"/>
                        </span>
                    </button>
                </div>
            </div>
        </div>
        <div id="overlayForModals" class="overlay"></div>
        <div id="boardListModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <i class="fas fa-microchip"></i>
                    <span id="boardListModalHeader_span"></span>
                    <span class="closeModal" id="closeModalBoards">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="board_mini_picture_div">
                        <img id="board_mini_picture" />
                    </div>
                    <div id="hideSelectScrollbar">
                        <select id="boardDescriptionSelector" size="11" onchange="Code.boardDescription()">
                            <optgroup label="C / C++">
                                <option value="none" >...</option>
                            	<option value="arduino_leonardo">Arduino Léonardo</option>
                            	<option value="arduino_mega">Arduino Mega</option>
                            	<option value="arduino_micro">Arduino Micro</option>
                            	<option value="arduino_mini">Arduino Mini</option>
                            	<option value="arduino_nano">Arduino Nano</option>
                            	<option value="arduino_pro8">Arduino Pro Mini 3.3V</option>
                            	<option value="arduino_pro16">Arduino Pro Mini 5V</option>
                            	<option value="arduino_uno">Arduino Uno</option>
                            	<option value="arduino_yun">Arduino Yùn</option>
                            	<option value="lilypad">LilyPad</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <button id="boardListModalDialogOkay" onclick="Code.changeBoard()">&#10004;</button>
                <button type="button" class="collapsibleButton">
                    <span id="boardListModalButton_span">Details</span>
                </button>
                <div class="collapsibleContent" id="collapsibleContent">
                    <span id="boardModal_connect"></span><span id="boardModal_connect_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_voltage"></span><span id="boardModal_voltage_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_voltage_normal"></span><span id="boardModal_voltage_normal_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_voltage_maxi"></span><span id="boardModal_voltage_maxi_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_cpu"></span><span id="boardModal_cpu_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_speed"></span><span id="boardModal_speed_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_inout"></span><span id="boardModal_inout_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_in_analog"></span><span id="boardModal_in_analog_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_out_analog"></span><span id="boardModal_out_analog_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_i_max_out"></span><span id="boardModal_i_max_out_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_i_max3"></span><span id="boardModal_i_max3_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_i_max_5"></span><span id="boardModal_i_max_5_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_flash"></span><span id="boardModal_flash_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_sram"></span><span id="boardModal_sram_span" class="modalBoard_info">...</span><br>
                    <span id="boardModal_eeprom"></span><span id="boardModal_eeprom_span" class="modalBoard_info">...</span><br>
                </div> 
            </div>
        </div>
        <div id="portListModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <i class="fab fa-usb"></i>
                    <span id="portListModalHeader_span"></span>
                    <span class="closeModal" id="closeModalPorts">&times;</span>
                </div>
                <div class="modal-body" id="portListModalBody">
                </div>
                <div class="modal-footer">
                    <select id="serialMenu">
                        <option value="none">...</option>
                    </select>
                    <button id="portListModalDialogOkay" onclick="Code.setPort()">&#10004;</button>
                </div>
            </div>
        </div>
        <div id="motorControls">
            <button id="forwardButton">Forward</button>
            <button id="backwardButton">Backward</button>
            <button id="stopButton">Stop</button>
          </div>
    <button id="executeButton" class="executeButton" onclick="executeSequence()" style="
          padding: 10px 20px;
          background-color: #4CAF50;
          color: white;
          border: none;
          border-radius: 5px;
          font-size: 16px;
          cursor: pointer;">
      Execute
    </button>
    
    <script>
        function updateExecButtonPosition() {
          var trash = document.querySelector('.blocklyTrash');
          var execButton = document.getElementById('executeButton');
          
          if (trash && execButton) {
            var rect = trash.getBoundingClientRect();
            execButton.style.position = 'absolute';
            execButton.style.top = (rect.top + 50) + 'px';
            execButton.style.left = (rect.left - execButton.offsetWidth - 10) + 'px';
          }
        }
      
        window.addEventListener('load', function() {
          setTimeout(updateExecButtonPosition, 0);
          setInterval(updateExecButtonPosition, 0);
        });
      </script>

    <script>
function unrollForLoops(code) {
    var lines = code.split('\n');
    var expanded = [];
    var i = 0;
    
    while (i < lines.length) {
        var line = lines[i].trim();
        
        // Handle for-loops.
        if (line.startsWith("for(") || line.startsWith("for (")) {
            // Regex to capture the variable name, starting value, operator (< or <=) and ending value.
            var forLoopRegex = /for\s*\(\s*int\s+(\w+)\s*=\s*(\d+)\s*;\s*\1\s*(<|<=)\s*(\d+)\s*;/;
            var match = line.match(forLoopRegex);
            var iterations = 0;
            if (match) {
                var variable = match[1]; // Any variable name.
                var start = parseInt(match[2]);
                var operator = match[3];
                var end = parseInt(match[4]);
                
                if (operator === "<") {
                    iterations = end - start;
                } else if (operator === "<=") {
                    iterations = end - start + 1;
                }
            }
            
            // Advance until the opening "{" is found.
            while (i < lines.length && lines[i].indexOf("{") === -1) {
                i++;
            }
            i++; // Skip the "{" line.
            
            var loopBlock = [];
            // Capture lines inside the for-loop block.
            while (i < lines.length && lines[i].indexOf("}") === -1) {
                var bodyLine = lines[i].trim();
                if (bodyLine !== "") {
                    loopBlock.push(bodyLine);
                }
                i++;
            }
            
            console.log("Found for-loop block with", iterations, "iterations:", loopBlock);
            // Unroll the for-loop body.
            for (var j = 0; j < iterations; j++) {
                expanded = expanded.concat(loopBlock);
            }
            i++; // Skip the "}" line.
        }
        // Handle while-loops.
        else if (line.startsWith("while(") || line.startsWith("while (")) {
            // Instead of a regex, manually extract the condition to handle nested parentheses.
            var startIndex = line.indexOf('(');
            var depth = 0;
            var endIndex = -1;
            for (var k = startIndex; k < line.length; k++) {
                var ch = line.charAt(k);
                if (ch === '(') {
                    depth++;
                } else if (ch === ')') {
                    depth--;
                    if (depth === 0) {
                        endIndex = k;
                        break;
                    }
                }
            }
            var condition = line.substring(startIndex + 1, endIndex).trim();
            
            // Advance until the opening "{" is found.
            while (i < lines.length && lines[i].indexOf("{") === -1) {
                i++;
            }
            i++; // Skip the "{" line.
            
            var loopBlock = [];
            // Capture the while-loop block.
            while (i < lines.length && lines[i].indexOf("}") === -1) {
                var bodyLine = lines[i].trim();
                if (bodyLine !== "") {
                    loopBlock.push(bodyLine);
                }
                i++;
            }
            console.log("Found while-loop block with condition (" + condition + "):", loopBlock);
            
            // Unroll the while-loop until the condition evaluates to false.
            var maxIterations = 100; // safeguard to prevent infinite loops.
            var count = 0;
            // Pass an empty object for variables if not needed, or your current variables object.
            while (count < maxIterations && evaluateCondition(condition, {})) {
                expanded = expanded.concat(loopBlock);
                count++;
            }
            if (count === maxIterations) {
                console.warn("While-loop reached maximum iterations during unrolling.");
            }
            i++; // Skip the "}" line.
        }
        else {
            expanded.push(line);
            i++;
        }
    }
    return expanded;
}




        function getLoopCommands() {
        // Get the full generated code as a string.
        var code = editor.getValue(); // or document.getElementById("sourcecode").innerText
        
        // Use a regex to capture everything inside void loop() { ... }
        var loopRegex = /void\s+loop\s*\(\s*\)\s*{([\s\S]*?)^}/m;
        var match = code.match(loopRegex);
        
        if (match && match[1]) {
            var loopBody = match[1];
            // First, split into lines and filter out empty ones
            var lines = loopBody.split('\n').map(line => line.trim()).filter(line => line !== "");
            // Then unroll any for loops found
            var expandedCommands = unrollForLoops(lines.join('\n'));
            return expandedCommands;
        } else {
            console.error("Could not extract loop() content");
            return [];
        }
        }


        function evaluateCondition(condition, variables) {
  // Pre‐process any getCurrentLEDColor() calls.
  if (condition.includes("getCurrentLEDColor()")) {
    const ledColor = getCurrentLEDColor(); // Expected to return a string like "#FF0000"
    console.log("getCurrentLEDColor() returned:", ledColor);
    // Replace all occurrences with a properly quoted string.
    condition = condition.replace(/getCurrentLEDColor\(\)/g, `"${ledColor}"`);
    console.log("Condition after LED substitution:", condition);
  }

  // Build a "preamble" to declare all my_ variables found in the condition.
  // We expect tokens of the form my_ followed only by digits and underscores.
  const tokenPattern = /\b(my_[0-9_]+)\b/g;
  let preamble = "";
  let match;
  const declared = {};
  while ((match = tokenPattern.exec(condition)) !== null) {
    const varName = match[1];
    if (!(varName in variables) && !declared[varName]) {
      // Remove the "my_" prefix and replace underscores with a dot.
      let numberStr = varName.substring(3).replace(/_/g, ".");
      let numValue = parseFloat(numberStr);
      if (!isNaN(numValue)) {
        console.log(`Token ${varName} not found in variables; declaring it as ${numValue}.`);
        preamble += `var ${varName} = ${numValue};\n`;
      } else {
        console.log(`Token ${varName} not found in variables and cannot be parsed as a number; declaring as 0.`);
        preamble += `var ${varName} = 0;\n`;
      }
      declared[varName] = true;
    } else if (varName in variables) {
      console.log(`Token ${varName} found with value: ${variables[varName]}`);
    }
  }

  // Now add definitions for any variables already present.
  for (const key in variables) {
    preamble += `var ${key} = ${variables[key]};\n`;
  }
  
  console.log("Preamble for evaluation:\n", preamble);
  console.log("Final condition to evaluate:", condition);
  
  try {
    const evaluator = new Function(`${preamble} return (${condition});`);
    const result = evaluator();
    console.log(`Evaluated condition "${condition}" =>`, result);
    return result;
  } catch (err) {
    console.error("Error evaluating condition:", err);
    return false;
  }
}

function executeSequence() {
  const commands = getLoopCommands();
  console.log("Generated commands:", commands);
  let totalDelay = 0;
  const defaultDelay = 5000;

  // Dynamic variable storage.
  const variables = {};

  // Flags for conditional processing.
  let skipBlock = false;
  let inIfBlock = false;

  commands.forEach((line) => {
    line = line.trim();
    console.log("Processing:", line);

    // Detect variable assignments (numbers, e.g., "int my_1 = 5;")
    const assignMatch = line.match(/(?:int\s+)?(my_[0-9_]+)\s*=\s*(\d+(?:\.\d+)?);?/);
    if (assignMatch) {
      const name = assignMatch[1];
      const value = parseFloat(assignMatch[2]);
      variables[name] = value;
      console.log(`Set variable ${name} = ${value}`);
      console.log("Current variables:", JSON.stringify(variables));
      return; // Skip executing assignment lines.
    }
    
    // Detect the start of an if block.
    const ifMatch = line.match(/^if\s*\((.*?)\)\s*{?$/);
    if (ifMatch) {
      let condition = ifMatch[1];
      inIfBlock = true;
      
      // Pre-evaluate any getCurrentLEDColor() calls.
      if (condition.includes("getCurrentLEDColor()")) {
        const ledColor = getCurrentLEDColor();
        console.log("getCurrentLEDColor() returned:", ledColor);
        // Replace with a quoted value.
        condition = condition.replace(/getCurrentLEDColor\(\)/g, `"${ledColor}"`);
        console.log("Condition after LED substitution:", condition);
      }
      
      // Evaluate the condition.
      const result = evaluateCondition(condition, variables);
      console.log(`Evaluated condition "${condition}" =>`, result);
      skipBlock = !result;
      return; // Do not process the if header as a command.
    }
    
    // Detect the end of a block.
    if (line === "}") {
      inIfBlock = false;
      skipBlock = false;
      return;
    }
    
    // If inside an if block that evaluated false, skip this command.
    if (inIfBlock && skipBlock) {
      console.log("Skipping:", line);
      return;
    }
    
    // Regular command processing (e.g., moveForward(1000)).
    const durationMatch = line.match(/\((\d+)\)/);
    const duration = durationMatch ? parseInt(durationMatch[1]) : defaultDelay;
    console.log("Scheduling command:", line, "in", totalDelay, "ms");
    
    setTimeout(() => {
      console.log("Sending command:", line);
      fetch("/execute/" + encodeURIComponent(line))
        .then((res) => res.json())
        .then((data) => console.log("Executed command:", line, data))
        .catch((err) => console.error("Error executing command", line, err));
    }, totalDelay);
    
    totalDelay += duration;
  });
}



    </script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let cliAccordion = document.querySelector("button.accordion[aria-controls='accordion_CLI_content']");
        if (cliAccordion) {
            cliAccordion.style.display = "none";
        }
    });
    </script>

<script>
    function getCurrentLEDColor() {
      var xhr = new XMLHttpRequest();
      xhr.open("GET", "/execute/" + encodeURIComponent("GET_LED_COLOR"), false); // synchronous call
      try {
        xhr.send(null);
        if (xhr.status === 200) {
          // Parse the JSON response
          let json = JSON.parse(xhr.responseText);
          console.log("getCurrentLEDColor() returned:", json);
          // Return the actual LED color from the JSON object.
          return json.response;
        }
      } catch (e) {
        console.error("Error in getCurrentLEDColor()", e);
      }
      return "";
    }
  </script>
  
  
  
  
      
    </body>
    <!-- Blockly libraries -->
    <script src="./@blockly/blockly_compressed.js"></script>
    <script src="./@blockly/blocks_compressed.js"></script>
    <script src="./@blockly/closure/goog/base.js"></script>
    <!-- Blockly libraries for themes and renderers -->
    <script src="./@blockly/core/workspace_comment.js" async></script>
    <script src="./@blockly/core/workspace_comment_svg.js" async></script>
    <script src="./@blockly/core/workspace_comment_render_svg.js" async></script>
    <script src="./@blockly/core/renderers/minimalist/info.js" async></script>
    <script src="./@blockly/core/renderers/minimalist/constants.js" async></script>
    <script src="./@blockly/core/renderers/minimalist/drawer.js" async></script>
    <script src="./@blockly/core/renderers/minimalist/renderer.js" async></script>
    <script src="./@blockly/core/theme/modern.js" async></script>
    <script src="./@blockly/core/theme/zelos.js" async></script>
    <!-- Blockly libraries of function, from different demos -->
    <script src="./@blockly/demos/code/code.js"></script>
    <script src="./@blockly/demos/keyboard_nav/line_cursor.js" async></script>
    <script src="./@blockly/tests/playgrounds/screenshot.js" async></script>
    <!-- BlocklyDuino external toolbox hacked -->
    <script src="./blocklyduino/toolbox/toolbox_arduino.json"></script>
    <script src="./blocklyduino/toolbox/toolbox_ds18b20.json"></script>
    <script src="./blocklyduino/toolbox/toolbox_grove.json"></script>
    <script src="./blocklyduino/toolbox/toolbox_relay.json"></script>
    <script src="./blocklyduino/toolbox/toolbox_servo.json"></script>
    <script src="./blocklyduino/toolbox/toolbox_standard.json"></script>
    <!-- Blockly libraries of function, hacked from different demos -->
    <script src="./js/motorControl.js"></script>
    <script src="./js/blockly/keyboard_nav.js"></script>
    <script src="./js/blockly/playground.js"></script>
    <script src="./js/init.js"></script>
    <script src="./js/typed_variable.js"></script>
    <script src="./js/buttons_functions.js"></script>
    <script src="./js/dialog.js"></script>
    <script src="./js/renderingConstant.js"></script>
    <script src="./js/toolbox.js"></script>
    <script src="./@blockly/demos/custom-dialogs/custom-dialog.js"></script>
    <!-- blocklyduino libraries of external functions -->
    <script src="./js/ace/ace.js" charset="utf-8"></script>
    <script src="./js/ace/ext-language_tools.js"></script>
    <!-- S4E libraries of specific funtions definition -->
    <script src="./blocklyduino/js/override_toolbox.js"></script>
    <!-- blocklyduino libraries of boards definition -->
    <script src="./blocklyduino/js/boards.json"></script>
    <script src="./blocklyduino/js/boards.js"></script>
    <!-- blocklyduino specific: block design -->
    <!-- <script src="./blocklyduino/blocks/blocks_colors.js" async></script> -->
    <script src="./blocklyduino/blocks/board/board_base.js" async></script>
    <script src="./blocklyduino/blocks/board/board_serial.js" async></script>
    <script src="./blocklyduino/blocks/blockly/logic.js" async></script>
    <script src="./blocklyduino/blocks/blockly/math.js" async></script>
    <script src="./blocklyduino/blocks/ds18b20/ds18b20.js" async></script>
    <script src="./blocklyduino/blocks/grove/grove.js" async></script>
    <script src="./blocklyduino/blocks/relay/relay.js" async></script>
    <script src="./blocklyduino/blocks/servo/servo.js" async></script>
    <script src="./blocklyduino/blocks/typed_variable.js" async></script>
    <!-- blocklyduino specific: common generator code -->
    <script src="./generators/arduino_generator.js"></script>
    <script src="./blocklyduino/arduino/blockly/colour.js" async></script>
    <script src="./blocklyduino/arduino/blockly/lists.js" async></script>
    <script src="./blocklyduino/arduino/blockly/logic.js" async></script>
    <script src="./blocklyduino/arduino/blockly/loops.js" async></script>
    <script src="./blocklyduino/arduino/blockly/math.js" async></script>
    <script src="./blocklyduino/arduino/blockly/procedures.js" async></script>
    <script src="./blocklyduino/arduino/blockly/text.js" async></script>
    <!-- blocklyduino specific: addon generator code -->
    <script src="./blocklyduino/arduino/board/board_base.js" async></script>
    <script src="./blocklyduino/arduino/board/board_serial.js" async></script>
    <script src="./blocklyduino/arduino/typed_variable.js" async></script>
    <script src="./blocklyduino/arduino/addon/ds18b20.js" async></script>
    <script src="./blocklyduino/arduino/addon/grove.js" async></script>
    <script src="./blocklyduino/arduino/addon/relay.js" async></script>
    <script src="./blocklyduino/arduino/addon/servo.js" async></script>
    <!-- blocklyduino specific -->
    <!-- Blockly themes added -->
    <script src="./blocklyduino/themes/bw.js" async></script>
    <script src="./blocklyduino/themes/themes_blocks.js" async></script>
    <script src="./blocklyduino/themes/themes_categories.js" async></script>
    <script src="./blocklyduino/themes/themes_components_override.js" async></script>
    <script>
        Blockly.Blocks['motor_control'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Motor")
                    .appendField(new Blockly.FieldDropdown([["Forward", "F"], ["Backward", "B"], ["Stop", "S"]]), "DIRECTION")
                    .appendField("for")
                    .appendField(new Blockly.FieldTextInput("5"), "DURATION")
                    .appendField("s");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("Controls motor direction for a duration (in seconds).");
            }
        };

    
        Blockly.Arduino['motor_control'] = function(block) {
            var direction = block.getFieldValue('DIRECTION');
            var duration = Number(block.getFieldValue('DURATION')) * 1000; // convert seconds to ms
            var code = "";
            if (direction === "F") {
                code += "moveForward(" + duration + ");\n";
            } else if (direction === "B") {
                code += "moveBackward(" + duration + ");\n";
            } else {
                code += "stopMotor();\n";
            }
            return code;
        };


    </script>
    
    <script>
        ace.require("ace/ext/language_tools");
        var editor = ace.edit("content_code");
        editor.setTheme("ace/theme/sqlserver");
        editor.session.setMode("ace/mode/c_cpp");
        editor.setShowPrintMargin(false);
        editor.setOptions({
            autoScrollEditorIntoView: false,
            readOnly: false,
            highlightGutterLine: true,
            animatedScroll: true,
            enableBasicAutocompletion: true,
            enableSnippets: true,
            enableLiveAutocompletion: true
        });
        editor.find('needle', {
            backwards: false,
            wrap: false,
            caseSensitive: false,
            wholeWord: false,
            regExp: false
        });
        editor.findNext();
        editor.findPrevious();
        <!-- require('../CLI_functions.js'); -->
        <!-- require('../IDE_functions.js'); -->
        require('../resources/app.asar/CLI_functions.js');
        require('../resources/app.asar/IDE_functions.js');
        require('../nodejs/js/webServer.js');
    </script>
    <script>
        function addMotorBlock(direction) {
            var xmlText = `
                <xml>
                    <block type="motor_control">
                        <field name="DIRECTION">${direction}</field>
                    </block>
                </xml>`;
    
            var xml = Blockly.Xml.textToDom(xmlText);
            var workspace = Blockly.getMainWorkspace();
            Blockly.Xml.domToWorkspace(xml, workspace);
        }
    </script>

    
    
</HTML>